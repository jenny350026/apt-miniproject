{% extends "/templates/base.html" %}

{% block content %}

	<div class="panel panel-default">
		<div class="panel-heading">Streams I own</div>

		<div class="panel-body">			
			<div class="col-md-12">
				<table class="table table-condensed" id="manage_table">
					<thead>
						<tr>
							<th>#</th>
							<th>Name</th>
							<th>Last New Picture</th>
							<th>Number of Pictures</th>
							<th>Views</th>
							<th>Delete</th>
						</tr>
					</thead>
					<tbody>
						{% for stream in streams %}
						<tr class="my_streams" id="tablerow{{ stream.name }}">
							<td>{{ loop.index }}</td>
							<td><a href="/stream?stream_id={{ stream.key.urlsafe() }}&view=true">@{{ stream.name }}</a></td>
							<td>{{ stream.last_update_time.strftime("%Y/%m/%d %I:%M %p") }}</td>
							<td>{{ stream.num_picture }}</td>
							<td>{{ stream.view_count }}</td>
							<td>
								<label class="checkbox" for="checkbox{{ loop.index }}">
						            <input type="checkbox" name="{{ stream.name }}" id="checkbox{{ loop.index }}" data-toggle="checkbox">	  
						        </label>									
							</td>
							<script>
								$(':checkbox').radiocheck();
							</script>
						<tr>
						{% endfor%}
					</tbody>
				</table>
				<form role="form" action="deleteStream" method="post">
					<input type="hidden" id="stream_names" name="stream_names">
				<button type="submit" id="remove" class="btn btn-md btn-primary">Delete Checked</button>
				</form>
			</div>			
		</div>
	</div>

	<script>
	$(document).ready(function() {
		var $manage_table = $('#manage_table');
		$("#remove").on('click', function(e) {			
	        e.preventDefault();
	        var my_streams_checked = [];
	        var checked_items = [];
	        $(".my_streams .checkbox input:checked").each(
	            function() {	            		            	
	               	my_streams_checked.push($(this).attr('name'));		               	
	               	checked_items.push($(this).parent().parent());
	            }
	        );

	        var res = "stream_name=";
	        var i = 0;	      
	        for (i = 0; i < my_streams_checked.length; i++) {
	            res += encodeURIComponent(my_streams_checked[i]);
	            if (i < my_streams_checked.length-1) {
	                res += "&stream_name="
	            }
	        }
      
	       
	        $.ajax({
	            type: 'POST',
	            url: 'deleteStream',
	            data: res,
	            success: function(msg) {
	            	console.log(msg)
	                if (msg === 'Success') {
	                    for (i = 0; i < checked_items.length; i++) {	                    	
	                    	$('#tablerow'+ my_streams_checked[i]).remove();
	                    }

	                }	               
	            }
	        });

	    });
	});
	</script>

	<div class="panel panel-default">
		<div class="panel-heading">Streams I subscribed to</div>

		<div class="panel-body">
			<div class="row">
				<form action="/unsubscribe" method="post">
					<div class="col-md-12">
						<table class="table table-condensed">
				            <thead>
				              <tr>
				                <th>#</th>
				                <th>Name</th>
				                <th>Last New Picture</th>
				                <th>Number of Pictures</th>
				                <th>Views</th>
				                <th>Unsubscribe</th>
				              </tr>
				            </thead>

				            <tbody>
				            	{% for subscription in subscribed %}	
								<tr>
									<td>{{ loop.index }}</td>
									<td><a href="/stream?stream_id={{ subscription.stream.urlsafe() }}&view=true">{{ subscription.stream.get().name }}</a></td>
									<td>{{ subscription.stream.get().last_update_time.strftime("%Y-%m-%d %I:%M:%S %p")}}</td>
									<td>{{ subscription.stream.get().num_picture }}</td>
									<td>{{ subscription.stream.get().view_count }}</td>
									<td>
										<label class="checkbox" for="checkbox{{ loop.index }}">
								            <input type="checkbox" name="{{ subscription.stream.get().name }}" id="checkbox{{ loop.index }}" data-toggle="checkbox">	  
								        </label>										
									</td>
								<tr>
								{% endfor %}
				            </tbody>
				          </table>
				          <button type="submit" class="btn btn-md btn-primary">Unsubscribe Checked Streams</button>
				    </div>
				</form>
			</div>
		</div>
	</div>
{% endblock %}
